"use strict";var e=require("react"),t=require("react-hook-form"),n=require("zod"),r=require("@hookform/resolvers/zod");const o="_rtf_id";function i(e){return o in e._def}function d(e,t,n,r){return new(n||(n=Promise))((function(o,i){function d(e){try{a(r.next(e))}catch(e){i(e)}}function s(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(d,s)}a((r=r.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const s=new Set([n.z.ZodFirstPartyTypeKind.ZodOptional,n.z.ZodFirstPartyTypeKind.ZodNullable,n.z.ZodFirstPartyTypeKind.ZodBranded,n.z.ZodFirstPartyTypeKind.ZodDefault]);function a(e){let t=e,r=null;for(;s.has(t._def.typeName);)switch(i(t)&&(r=t._def[o]),t._def.typeName){case n.z.ZodFirstPartyTypeKind.ZodOptional:t=t._def.innerType;break;case n.z.ZodFirstPartyTypeKind.ZodBranded:t=t._def.type;break;case n.z.ZodFirstPartyTypeKind.ZodNullable:case n.z.ZodFirstPartyTypeKind.ZodDefault:t=t._def.innerType}let d=null;return i(t)&&(d=t._def[o]),{type:t,[o]:d||r}}function u(e){return e._def.typeName===n.ZodFirstPartyTypeKind.ZodEffects?e._def.schema:e}function c(e,t){let{type:r,_rtf_id:o}=a(e),{type:i,_rtf_id:d}=a(t);if(o||d)return o===d;if(r._def.typeName!==i._def.typeName)return!1;if(r._def.typeName===n.ZodFirstPartyTypeKind.ZodArray&&i._def.typeName===n.ZodFirstPartyTypeKind.ZodArray)return!!c(r._def.type,i._def.type);if(r._def.typeName===n.ZodFirstPartyTypeKind.ZodSet&&i._def.typeName===n.ZodFirstPartyTypeKind.ZodSet)return!!c(r._def.valueType,i._def.valueType);if(r._def.typeName===n.ZodFirstPartyTypeKind.ZodMap&&i._def.typeName===n.ZodFirstPartyTypeKind.ZodMap)return!(!c(r._def.keyType,i._def.keyType)||!c(r._def.valueType,i._def.valueType));if(r._def.typeName===n.ZodFirstPartyTypeKind.ZodRecord&&i._def.typeName===n.ZodFirstPartyTypeKind.ZodRecord)return!!c(r._def.valueType,i._def.valueType);if(r._def.typeName===n.ZodFirstPartyTypeKind.ZodTuple&&i._def.typeName===n.ZodFirstPartyTypeKind.ZodTuple){const e=r._def.items,t=i._def.items;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!c(e[n],t[n]))return!1;return!0}if(r._def.typeName===n.ZodFirstPartyTypeKind.ZodObject&&i._def.typeName===n.ZodFirstPartyTypeKind.ZodObject){const e=r._def.shape(),t=i._def.shape();if(!e||!t)return!e&&!t;const n=Object.keys(e),o=Object.keys(t),d=new Set(n),a=new Set(o);for(const e of o)if(!d.has(e))return!1;for(const e of n)if(!a.has(e))return!1;for(var s of n){const n=e[s],r=t[s];if(!r||!c(n,r))return!1}}return!0}function f(e,t){return e._def.typeName===n.ZodFirstPartyTypeKind[t]}const l=" // ";function p(e){if(!e)return;const[t,...n]=e.split(l).map((e=>e.trim())),r=n.join(l);return{label:t,placeholder:r||void 0}}function m(e){if(e._def.typeName===n.z.ZodFirstPartyTypeKind.ZodEnum)return e._def.values}const y=n.z.object({}),h=n.z.object({message:n.z.string(),type:n.z.string()});function b(e){if(!function(e){return y.safeParse(e).success}(e))return;if(function(e){return h.safeParse(e).success}(e))return{errorMessage:e.message};const t={};for(const n in e)t[n]=b(e[n]);return t}const v=e.createContext(null);function _({name:t,control:n,children:r,label:o,placeholder:i,enumValues:d,zodType:s,addToCoerceUndefined:a,removeFromCoerceUndefined:u}){return e.createElement(v.Provider,{value:{control:n,name:t,label:o,placeholder:i,enumValues:d,zodType:s,addToCoerceUndefined:a,removeFromCoerceUndefined:u}},r)}function F(t){const n=e.useContext(v);if(!n)throw Error(`${t} must be called from within a FieldContextProvider... if you use this hook, the component must be rendered by @ts-react/form.`);return n}function T(e,t){return`No ${e} found when calling ${t}. Either pass it as a prop or pass it using the zod .describe() syntax.`}function g(e){const{type:t,_rtf_id:n}=a(e);return{type:t,zodType:e,uniqueId:null!=n?n:void 0,isOptional:e.isOptional(),isNullable:e.isNullable(),defaultValue:function(){const t=e._def;if(n=t,Boolean(n&&"object"==typeof n&&"defaultValue"in n&&"function"==typeof n.defaultValue)){return t.defaultValue()}var n}()}}function Z(e){const{zodType:t,label:n,placeholder:r}=F(e),o=g(t);return Object.assign(Object.assign({},o),{label:n,placeholder:r})}function E(e,t,n){const r=Z(n);const o=function(){const{type:t}=r;if("ZodArray"!==e&&f(t,"ZodArray")){return t.element}return t}();if(!f(o,e))throw new Error(function(e,{expectedType:t,receivedType:n}){return`Make sure that the '${e}' hook is being called inside of a custom form component which matches the correct type.\n  The expected type is '${t}' but the received type was '${n}'`}(n,{expectedType:e,receivedType:o._def.typeName}));return Object.assign(Object.assign({},function(e,t){return Object.entries(t).reduce(((t,[n])=>{const r=e[n];return"string"!=typeof r&&"number"!=typeof r&&"boolean"!=typeof r&&"bigint"!=typeof r&&void 0!==r||(t[n]=r),t}),{})}(o,t)),r)}const P={enum:!1,useEnum:!1,duplicateSchema:!1};function j(){var e;P.duplicateSchema||(P.duplicateSchema=!0,e="Found duplicate zod schema in zod-component mapping. Each zod type in the mapping must be unique, if you need to map multiple of the same types to different schemas use createUniqueFieldSchema.",console.warn(`@ts-react/form: ${e}`))}const O=[["name","name"],["control","control"],["enumValues","enumValues"]];const N=e=>e._def.typeName===n.ZodFirstPartyTypeKind.ZodObject,w=e=>e._def.typeName===n.ZodFirstPartyTypeKind.ZodArray;function z(t){return Array.isArray(t)?t.flatMap((e=>z(e))):"object"!=typeof t||null===t||e.isValidElement(t)?[t]:Object.values(t).reduce(((e,t)=>e.concat(z(t))),[])}exports.createTsForm=function(n,s){const f=(null==s?void 0:s.FormComponent)?s.FormComponent:"form",l=n.map((e=>e[0]));!function(e){var t=e.flatMap(((t,n)=>e.slice(n+1).map((e=>[t,e]))));for(const[e,n]of t)c(e,n)&&j()}(l),function(e){let t=new Set;for(const n of e)if(i(n)){if(t.has(n._def[o]))throw new Error(`Duplicate id passed to createFieldSchema: ${n._def[o]}. Ensure that each id is only being used once and that createFieldSchema is only called at the top level.`);t.add(n._def[o])}}(l);const y=function(e){const t={};for(const[n,r]of e)t[n]=r;return t}((null==s?void 0:s.propsMap)?s.propsMap:O);return function({schema:o,onSubmit:i,props:s,formProps:l,defaultValues:b,renderAfter:v,renderBefore:F,form:T,children:g}){if(!!e.useRef(T).current!=!!T)throw new Error("useFormResult prop changed - its value shouldn't changed during the lifetime of the component.");const Z=r.zodResolver(o),E=(()=>{if(T)return T;return t.useForm({resolver:Z,defaultValues:b})})();e.useEffect((()=>{T&&b&&T.reset(b)}),[]);const{control:P,handleSubmit:j,setError:O,getValues:z}=E,S=function({resolver:t,onSubmit:n,setError:r}){const o=e.useRef(new Set);function i(e){o.current.add(e)}function s(e){o.current.delete(e)}function a(e){const t=Object.assign({},e);for(const e of o.current)delete t[e];return t}function u(e){return t(a(e),{},{}).then((e=>d(this,void 0,void 0,(function*(){const t=Object.keys(e.errors);if(t.length)for(const n of t)r(n,e.errors[n]);else yield n(e.values)}))))}return{submit:u,removeUndefined:a,removeFromCoerceUndefined:s,addToCoerceUndefined:i}}({resolver:Z,onSubmit:i,setError:O}),C=j(S.submit);function K(t,r,o,i,d){var s,f,l,h,b;const v=u(t),F=function(e,t){for(const n of t)if(c(e,n[0]))return n[1]}(v,n);if(!F){if(N(v)){const e=v._def.shape();return Object.entries(e).reduce(((e,[t,n])=>(e[t]=K(n,r&&r[t]?r[t]:void 0,t,`${i}.${t}`,d&&d[t]),e)),{})}if(w(v))return(null!==(s=d)&&void 0!==s?s:[]).map(((e,t)=>K(v.element,r,o,`${i}[${t}]`,e)));throw new Error((T=o.toString(),`No matching zod schema for type \`${v._def.typeName}\` found in mapping for property \`${T}\`. Make sure there's a matching zod schema for every property in your schema.`))}var T;const g=function(e){const t=a(e),n=function(e){let t=e;if(t._def.description)return t._def.description;for(;"unwrap"in t;)if(t=t.unwrap(),t._def.description)return t._def.description}(e);return{description:p(n),enumValues:m(t.type)}}(v),Z=r&&r[o]?r[o]:{},{beforeElement:E,afterElement:j}=Z,O=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},y.name&&{[y.name]:i}),y.control&&{[y.control]:P}),y.enumValues&&{[y.enumValues]:g.enumValues}),y.descriptionLabel&&{[y.descriptionLabel]:null===(f=g.description)||void 0===f?void 0:f.label}),y.descriptionPlaceholder&&{[y.descriptionPlaceholder]:null===(l=g.description)||void 0===l?void 0:l.placeholder}),Z),z=null===(h=g.description)||void 0===h?void 0:h.label,C=null===(b=g.description)||void 0===b?void 0:b.placeholder;return e.createElement(e.Fragment,{key:i},E,e.createElement(_,{control:P,name:i,label:z,zodType:v,placeholder:C,enumValues:g.enumValues,addToCoerceUndefined:S.addToCoerceUndefined,removeFromCoerceUndefined:S.removeFromCoerceUndefined},e.createElement(F,Object.assign({key:i},O))),j)}const x=function(e,t){const n=u(e)._def.shape();return Object.entries(n).reduce(((e,[n,r])=>{const o=n.toString();return e[o]=K(r,t,o,o,z()[n]),e}),{})}(o,s);return e.createElement(t.FormProvider,Object.assign({},E),e.createElement(f,Object.assign({},l,{onSubmit:C}),F&&F({submit:C}),e.createElement(h,{renderedFields:x,customChildRenderProp:g}),v&&v({submit:C})))};function h({customChildRenderProp:t,renderedFields:n}){return e.createElement(e.Fragment,null,t?t(n):z(n))}},exports.createUniqueFieldSchema=function(e,t){return function(e,t){for(const n in t)e._def[n]=t[n];return e}(e.brand(),{[o]:t})},exports.useDateFieldInfo=function(){const e=E("ZodDate",{description:!0,maxDate:!0,minDate:!0},"useDateFieldInfo");return Object.assign(Object.assign({},e),{maxDate:e.type.maxDate,minDate:e.type.minDate})},exports.useDescription=function(){const{label:e,placeholder:t}=F("useReqDescription");return{label:e,placeholder:t}},exports.useEnumValues=function(){const{enumValues:e}=F("useEnumValues");if(!e)throw new Error("Enum values not passed. Any component that calls useEnumValues should be rendered from an '.enum()' zod field.");return e},exports.useFieldInfo=function(){return Z("useFieldInfo")},exports.useNumberFieldInfo=function(){return E("ZodNumber",{description:!0,isFinite:!0,isInt:!0,maxValue:!0,minValue:!0},"useNumberFieldInfo")},exports.useReqDescription=function(){const{label:e,placeholder:t}=F("useReqDescription");if(!e)throw new Error(T("label","useReqDescription"));if(!t)throw new Error(T("placeholder","useReqDescription"));return{label:e,placeholder:t}},exports.useStringFieldInfo=function(){return E("ZodString",{description:!0,isCUID:!0,isCUID2:!0,isDatetime:!0,isEmail:!0,isEmoji:!0,isIP:!0,isULID:!0,isURL:!0,isUUID:!0,maxLength:!0,minLength:!0},"useStringFieldInfo")},exports.useTsController=function(){const n=F("useTsController"),r=t.useController(n),{fieldState:o,field:{onChange:i,value:d}}=r,[s,a]=e.useState(!1);return e.useEffect((()=>{d&&s&&(a(!1),n.removeFromCoerceUndefined(n.name))}),[d]),Object.assign(Object.assign({},r),{error:b(o.error),field:Object.assign(Object.assign({},r.field),{value:s?void 0:r.field.value,onChange:function(e){void 0===e?(a(!0),n.addToCoerceUndefined(n.name)):(a(!1),n.removeFromCoerceUndefined(n.name),i(e))}})})};
